<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Farmer Chatbot</title>
<style>
  body{font-family:Arial,system-ui;background:#f2f2f2;margin:0;padding:0;}
  .chat-container{max-width:760px;margin:24px auto;background:#fff;padding:18px;border-radius:12px;box-shadow:0 6px 20px rgba(0,0,0,0.08);display:flex;flex-direction:column;}
  h2{text-align:center;color:#2e7d32;margin:6px 0 12px;}
  .status{display:flex;gap:12px;align-items:center;font-size:0.9rem;color:#444;margin-bottom:8px;flex-wrap:wrap;}
  .messages{max-height:560px;overflow-y:auto;margin-bottom:12px;padding:8px;display:flex;flex-direction:column;gap:8px;}
  .message{padding:10px 14px;border-radius:14px;max-width:78%;word-wrap:break-word;position:relative;}
  .user{align-self:flex-end;background:#dcf8c6;text-align:right;border-bottom-right-radius:6px;}
  .assistant{align-self:flex-start;background:#fff;border:1px solid #eee;color:#111;border-bottom-left-radius:6px;}
  .meta{font-size:0.75rem;color:#666;margin-top:6px;}
  form{display:flex;gap:8px;align-items:center;margin-top:6px;}
  input[type=text]{flex:1;padding:10px 12px;border-radius:20px;border:1px solid #ccc;font-size:1rem;}
  button{padding:10px 14px;border-radius:20px;border:none;background:#2e7d32;color:white;cursor:pointer;}
  button.secondary{background:#4CAF50;}
  #typing{font-style:italic;color:#777;display:none;margin-bottom:6px;}
  select{padding:8px;border-radius:8px;border:1px solid #ccc;}
  .small{font-size:0.85rem;color:#666;}
</style>
</head>
<body>
<div class="chat-container">
  <h2>Farmer Chatbot</h2>

  <div class="status">
    <div id="locStatus" class="small">Location: detectingâ€¦</div>
    <div id="weatherStatus" class="small"></div>
    <div id="timeStatus" class="small"></div>
    <div style="margin-left:auto">
      Speak language:
      <select id="langSelect" title="Override speech language">
        <option value="auto">Auto (browser)</option>
        <option value="en-US">English (en-US)</option>
        <option value="hi-IN">Hindi (hi-IN)</option>
        <option value="ta-IN">Tamil (ta-IN)</option>
        <option value="te-IN">Telugu (te-IN)</option>
        <option value="kn-IN">Kannada (kn-IN)</option>
        <option value="fr-FR">French (fr-FR)</option>
        <option value="es-ES">Spanish (es-ES)</option>
      </select>
    </div>
  </div>

  <div class="messages" id="messages">
    <% messages.forEach(msg => { %>
      <div class="message <%= msg.role %>">
        <strong><%= msg.role === 'user' ? 'You' : 'Assistant' %>:</strong>
        <div><%- msg.text.replace(/\n/g, '<br>') %></div>
        <div class="meta"><%= new Date(msg.createdAt).toLocaleString() %> (<%= msg.language %>)</div>
      </div>
    <% }) %>
  </div>

  <div id="typing">Assistant is preparing a voice reply...</div>

  <form id="chatForm">
    <input type="text" id="userInput" placeholder="Ask your question..." autocomplete="off" />
    <button type="submit" id="sendBtn">Send</button>
  </form>

  <div style="display:flex;gap:8px;margin-top:8px;">
    <button id="startMic" class="secondary">ðŸŽ¤ Speak</button>
    <button id="newChat">ðŸ†• New Chat</button>
  </div>
</div>

<script>
// DOM elements
const messagesDiv = document.getElementById('messages');
const chatForm = document.getElementById('chatForm');
const userInput = document.getElementById('userInput');
const typingDiv = document.getElementById('typing');
const startMic = document.getElementById('startMic');
const newChatBtn = document.getElementById('newChat');
const locStatus = document.getElementById('locStatus');
const weatherStatus = document.getElementById('weatherStatus');
const timeStatus = document.getElementById('timeStatus');
const langSelect = document.getElementById('langSelect');
const sendBtn = document.getElementById('sendBtn');

let currentLocation = null;
let voicesReady = false;
let availableVoices = [];
let stopRequested = false;

// --- Helper to escape HTML ---
function escapeHtml(s){ if(!s) return ''; return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }

function appendMessage(role,text,meta, langCode){
  const d = document.createElement('div');
  d.className = 'message ' + (role==='You' ? 'user' : 'assistant');
  const metaStr = escapeHtml(meta || new Date().toLocaleString()) + (langCode ? ` (${escapeHtml(langCode)})` : '');
  d.innerHTML = `<strong>${role}:</strong><div>${escapeHtml(text).replace(/\n/g,'<br>')}</div>
                 <div class="meta">${metaStr}</div>`;
  messagesDiv.appendChild(d);
  messagesDiv.scrollTop = messagesDiv.scrollHeight;
}

// --- Stop/Send button helpers ---
function setSendAsStop(isStop){
  if(isStop){
    sendBtn.textContent = 'Stop';
    sendBtn.style.background = '#f44336';
  } else {
    sendBtn.textContent = 'Send';
    sendBtn.style.background = '#2e7d32';
  }
}

function cancelOngoing(){
  stopRequested = true;
  if(window.speechSynthesis && window.speechSynthesis.speaking){
    window.speechSynthesis.cancel();
  }
}

// --- Fetch voices ---
function loadVoices(){
  return new Promise(resolve=>{
    const synth = window.speechSynthesis;
    let voices = synth.getVoices();
    if(voices.length){
      availableVoices = voices;
      voicesReady = true;
      resolve();
    } else {
      synth.onvoiceschanged = ()=>{
        availableVoices = synth.getVoices();
        voicesReady = true;
        resolve();
      };
    }
  });
}

// --- Preferred speech locale ---
function getPreferredSpeechLocale(serverLocale){
  const override = langSelect.value;
  if(override && override !== 'auto') return override;
  if(serverLocale) return serverLocale;
  return navigator.language || 'en-US';
}

// --- Speak function ---
function speakAndWait(text, locale){
  return new Promise(resolve=>{
    if(!text){ resolve(); return; }
    try {
      if(window.speechSynthesis && window.speechSynthesis.speaking){
        window.speechSynthesis.cancel();
      }
      const utter = new SpeechSynthesisUtterance(text);
      utter.lang = locale || navigator.language || 'en-US';
      utter.rate = 0.95;
      utter.pitch = 1;
      const voices = window.speechSynthesis.getVoices();
      if(voices && voices.length){
        const prefix = (utter.lang || '').split('-')[0];
        const voice = voices.find(v => (v.lang || '').toLowerCase().startsWith(prefix));
        if(voice) utter.voice = voice;
      }
      utter.onend = ()=> resolve();
      utter.onerror = ()=> resolve();
      window.speechSynthesis.speak(utter);
    } catch(e){ resolve(); }
  });
}

// --- Geolocation ---
function getLocationPromise(timeout=8000){
  return new Promise(resolve=>{
    if(!navigator.geolocation) return resolve(null);
    navigator.geolocation.getCurrentPosition(
      pos => resolve({ lat: pos.coords.latitude, lon: pos.coords.longitude }),
      err => { console.warn('Geolocation error', err); resolve(null); },
      { timeout }
    );
  });
}

async function initAutoDetect(){
  locStatus.textContent = 'Location: detectingâ€¦';
  currentLocation = await getLocationPromise();
  if(!currentLocation){
    locStatus.textContent = 'Location: unavailable (allow location/time)';
    return;
  }
  locStatus.textContent = `Location: ${currentLocation.lat.toFixed(4)}, ${currentLocation.lon.toFixed(4)}`;
}

// --- Streaming function with Stop ---
async function sendStreamed(text){
  if(!text?.trim()) return;
  appendMessage('You', text, new Date().toLocaleString());
  userInput.value='';
  typingDiv.style.display='block';
  userInput.disabled = true;
  setSendAsStop(true);
  stopRequested = false;

  const body = { prompt: text, role:'user', location: currentLocation, langOverride: langSelect.value };
  const res = await fetch('/stream',{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify(body)
  });

  if(!res.ok){
    appendMessage('Assistant',`Error: ${await res.text().catch(()=> 'Server error')}`, new Date().toLocaleString());
    typingDiv.style.display='none';
    userInput.disabled = false;
    setSendAsStop(false);
    return;
  }

  const reader = res.body.getReader();
  const decoder = new TextDecoder('utf-8');
  let buffer = '';
  let fullReply = '';
  let assistantLang = null;

  const metaTime = new Date().toLocaleString();
  const placeholder = document.createElement('div');
  placeholder.className = 'message assistant';
  placeholder.innerHTML = `<strong>Assistant:</strong><div></div><div class="meta">${escapeHtml(metaTime)}</div>`;
  messagesDiv.appendChild(placeholder);
  messagesDiv.scrollTop = messagesDiv.scrollHeight;
  const bodyDiv = placeholder.querySelector('div');

  while(true){
    if(stopRequested) break;
    const { value, done } = await reader.read();
    if(value){
      buffer += decoder.decode(value, { stream:true });
      let idx;
      while((idx=buffer.indexOf('\n\n'))!==-1){
        if(stopRequested) break;
        const block = buffer.slice(0, idx).trim();
        buffer = buffer.slice(idx+2);
        const lines = block.split('\n').map(l=>l.trim()).filter(Boolean);
        const dataLine = lines.find(l=>l.startsWith('data:'));
        if(!dataLine) continue;
        const obj = JSON.parse(dataLine.replace(/^data:\s*/, ''));
        if(obj.token){
          assistantLang = assistantLang || obj.language || null;
          fullReply += obj.token;
        }
        if(obj.error){
          bodyDiv.innerHTML += `<br>Error: ${escapeHtml(obj.error)}`;
        }
      }
    }
    if(done || stopRequested) break;
  }

  if(!stopRequested){
    const locale = getPreferredSpeechLocale(assistantLang);
    await speakAndWait(fullReply.trim(), locale);
  }

  if(fullReply.trim()) bodyDiv.innerHTML += escapeHtml(fullReply.trim()).replace(/\n/g,'<br>') + '<br>';

  typingDiv.style.display='none';
  placeholder.dataset.finalized='true';
  messagesDiv.scrollTop = messagesDiv.scrollHeight;
  userInput.disabled = false;
  setSendAsStop(false);
}

// --- Mic recognition ---
startMic.addEventListener('click', async ()=>{
  const Rec = window.SpeechRecognition || window.webkitSpeechRecognition;
  if(!Rec){ alert('Speech recognition not supported.'); return; }
  const rec = new Rec();
  const recLang = (langSelect.value && langSelect.value !== 'auto') ? langSelect.value : (navigator.language || 'en-US');
  rec.lang = recLang;
  rec.interimResults = false;
  rec.maxAlternatives = 1;

  startMic.textContent = 'Listening...';
  rec.onend = ()=> startMic.textContent = 'ðŸŽ¤ Speak';
  rec.onerror = ()=> startMic.textContent='ðŸŽ¤ Speak';

  rec.onresult = async ev=>{
    const t = ev.results[0][0].transcript;
    await sendStreamed(t);
  };
  rec.start();
});

// --- Send button click ---
sendBtn.addEventListener('click', async e=>{
  e.preventDefault();
  if(sendBtn.textContent==='Stop'){
    cancelOngoing();
    return;
  }
  const t = userInput.value.trim();
  if(t) await sendStreamed(t);
});

// --- Form submit (fallback) ---
chatForm.addEventListener('submit', async (e)=>{
  e.preventDefault();
  const t = userInput.value.trim();
  if(t) await sendStreamed(t);
});

// --- New chat ---
newChatBtn.addEventListener('click', async ()=>{
  if(!confirm('Clear chat history and memory?')) return;
  try {
    await fetch('/new-chat', { method: 'POST' });
    messagesDiv.innerHTML = '';
    weatherStatus.textContent = '';
    timeStatus.textContent = '';
  } catch (err) { alert('Failed to clear chat.'); }
});

// --- Init ---
window.addEventListener('load', async ()=>{
  if(window.speechSynthesis) await loadVoices();
  initAutoDetect();
});
</script>
</body>
</html>
